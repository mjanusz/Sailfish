

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Performance Tuning &mdash; Sailfish 0.2-alpha1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.2-alpha1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Sailfish 0.2-alpha1 documentation" href="index.html" />
    <link rel="next" title="Sailfish internals" href="internals.html" />
    <link rel="prev" title="Supported models, grids and boundary conditions" href="models.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="internals.html" title="Sailfish internals"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Supported models, grids and boundary conditions"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Sailfish 0.2-alpha1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="performance-tuning">
<h1>Performance Tuning<a class="headerlink" href="#performance-tuning" title="Permalink to this headline">¶</a></h1>
<p>Sailfish uses default settings that should make most simulations run at a reasonable
speed on modern GPUs.  There are however several tunable parameters that can be used to
increase the performance of specific simulations.  Finding the optimal values of
these parameters requires some experimentation on a case-by-case basis.  The
guide below suggests some useful strategies.  In all following subsections we
will assume that the CUDA backend is used.</p>
<div class="section" id="general-tuning-strategies">
<h2>General tuning strategies<a class="headerlink" href="#general-tuning-strategies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="adjusting-the-block-size">
<h3>Adjusting the block size<a class="headerlink" href="#adjusting-the-block-size" title="Permalink to this headline">¶</a></h3>
<p>This is the simplest optimization you should apply when trying to increase the
speed of a simulation.  Every lattice Boltzmann node in Sailfish is processed
in a separate GPU thread.  These threads are grouped into 1-dimensional <em>blocks</em>, which
allows them to exchange data.  The default block size is 64.  You can adjust this
to a higher value using the <tt class="docutils literal"><span class="pre">--block_size=N</span></tt> command line option.  Values that are
multiplies of 32 should be the most effective due to the architecture of the GPU
hardware.</p>
<p>As a rough guideline, use lower block sizes for more complex models and higher
block sizes for simpler ones (e.g. 128 for single fluid, but 64 for binary fluids).
The more complex the LB model used, the more registers the generated GPU code
will require.  You can check the number of registers used by adding <tt class="docutils literal"><span class="pre">--cuda-kernel-stats</span></tt>
to your command line options.  The simulation will then output something similar
to:</p>
<div class="highlight-python"><pre>CollideAndPropagate: l:0  s:3072  r:30  occ:(1.000000 tb:4 w:32 l:regs)
LBMUpdateTracerParticles: l:0  s:0  r:17  occ:(0.250000 tb:8 w:8 l:device)
SetInitialConditions: l:0  s:0  r:19  occ:(1.000000 tb:4 w:32 l:warps)</pre>
</div>
<p>Each line presents, in order: name of the CUDA kernel, number of bytes of
local memory, number of bytes of shared memory, number of registers, occupancy,
thread blocks per multiprocessor, warps per multiprocessor, name of the factor limiting
occupancy.  A large number of registers will limit the occupancy, which will usually
result in a lower performance of the kernel.  An occupancy of 0.5 or higher is best.
You only need to optimize the occupancy of the kernels that are executed the most
often (e.g. <tt class="docutils literal"><span class="pre">CollideAndPropagate</span></tt> in the example above is important because it is
executed for every time step. <tt class="docutils literal"><span class="pre">SetInitialConditions</span></tt> on the other hand is irrelevant,
as it is only used to initialize the simulation).</p>
</div>
<div class="section" id="limiting-register-usage">
<h3>Limiting register usage<a class="headerlink" href="#limiting-register-usage" title="Permalink to this headline">¶</a></h3>
<p>In order to increase the occupancy, you can force the CUDA compiler to use a lower
number of registers in the GPU code.  This can be done via the <tt class="docutils literal"><span class="pre">--cuda-nvcc-opts=--maxrregcount=X</span></tt>
which will cause the compiler to limit the number of registers to <tt class="docutils literal"><span class="pre">X</span></tt>.  If you use a low
value of <tt class="docutils literal"><span class="pre">X</span></tt>, some of the variables in the kernel will be moved from registers to
local memory (register spilling).  Local memory is much slower than the registers
however, so the net effect can be a performance degradation despite the higher occupancy.
Experimentation is advised.</p>
</div>
<div class="section" id="using-fast-math-functions">
<h3>Using fast math functions<a class="headerlink" href="#using-fast-math-functions" title="Permalink to this headline">¶</a></h3>
<p>CUDA code can use a faster, but less precise version of several common mathematical
functions (e.g. transcendental functions such as sine, cosine, square root or the exponential function).
These so-called <em>intrinsic</em> functions will be used if the <em>fast math</em> mode is turned on, which can be done
using the <tt class="docutils literal"><span class="pre">--cuda-nvcc-opts=--use_fast_math</span></tt> command line option.  This might slightly
increase the speed of some of the more complex LB models.  If you decide to apply this
optimization, watch out for degraded precision (always run regression tests of our simulation)
and increased register usage.</p>
</div>
</div>
<div class="section" id="nvidia-fermi-cards">
<h2>NVIDIA Fermi cards<a class="headerlink" href="#nvidia-fermi-cards" title="Permalink to this headline">¶</a></h2>
<p>Fermi devices are based on a new GPU architecture and can benefit from additional optimizations.
The general guidelines presented above still apply.</p>
<p>By default, Sailfish uses a lower precision version of the division operator and square root
function (same as in CUDA devices of compute capability 1.3 and lower).  This helps with
register usage and can be turned off by the <tt class="docutils literal"><span class="pre">--cuda-fermi-highprec</span></tt> option.</p>
<div class="section" id="block-size">
<h3>Block size<a class="headerlink" href="#block-size" title="Permalink to this headline">¶</a></h3>
<p>Fermi devices have more multiprocessors than GPUs of the previous generation. The multiprocessors
can also handle more threads, and have better scheduling capabilities (which make it possible
for the GPU to execute several different kernels simultaneously).</p>
<p>To fully take advantage of the available computational power, a larger block size will usually
be necessary (typically twice as large as for devices of the previous generation, but make sure
to check occupancy and register usage as well).</p>
</div>
</div>
<div class="section" id="performance-comparison-for-different-devices">
<h2>Performance comparison for different devices<a class="headerlink" href="#performance-comparison-for-different-devices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="single-precision">
<h3>Single precision<a class="headerlink" href="#single-precision" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/fc2715d012.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/fc2715d012.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/fc2715d012.png" src="_images/fc2715d012.png" />
</div>
</div>
<div class="section" id="double-precision">
<h3>Double precision<a class="headerlink" href="#double-precision" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/dc26567c4a.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/dc26567c4a.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/dc26567c4a.png" src="_images/dc26567c4a.png" />
</div>
</div>
</div>
<div class="section" id="performance-impact-of-the-block-size-single-precision">
<h2>Performance impact of the block size (single precision)<a class="headerlink" href="#performance-impact-of-the-block-size-single-precision" title="Permalink to this headline">¶</a></h2>
<div class="section" id="geforce-gtx-285">
<h3>GeForce GTX 285<a class="headerlink" href="#geforce-gtx-285" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/fb04114e76.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/fb04114e76.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/fb04114e76.png" src="_images/fb04114e76.png" />
</div>
</div>
<div class="section" id="tesla-c1060">
<h3>Tesla C1060<a class="headerlink" href="#tesla-c1060" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/f7546198ca.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/f7546198ca.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/f7546198ca.png" src="_images/f7546198ca.png" />
</div>
</div>
<div class="section" id="tesla-c2050">
<h3>Tesla C2050<a class="headerlink" href="#tesla-c2050" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/cebce53094.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/cebce53094.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/cebce53094.png" src="_images/cebce53094.png" />
</div>
</div>
</div>
<div class="section" id="performance-impact-of-the-block-size-double-precision">
<h2>Performance impact of the block size (double precision)<a class="headerlink" href="#performance-impact-of-the-block-size-double-precision" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>GeForce GTX 285<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/ad12353f15.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/ad12353f15.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/ad12353f15.png" src="_images/ad12353f15.png" />
</div>
</div>
<div class="section" id="id2">
<h3>Tesla C1060<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/09662d7330.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/09662d7330.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/09662d7330.png" src="_images/09662d7330.png" />
</div>
</div>
<div class="section" id="id3">
<h3>Tesla C2050<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>[<a class="reference external" href="./plot_directive/inline/5eced68f2a.hires.png">hires.png</a>, <a class="reference external" href="./plot_directive/inline/5eced68f2a.pdf">pdf</a>]</p>
<div class="figure">
<img alt="_images/5eced68f2a.png" src="_images/5eced68f2a.png" />
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Performance Tuning</a><ul>
<li><a class="reference internal" href="#general-tuning-strategies">General tuning strategies</a><ul>
<li><a class="reference internal" href="#adjusting-the-block-size">Adjusting the block size</a></li>
<li><a class="reference internal" href="#limiting-register-usage">Limiting register usage</a></li>
<li><a class="reference internal" href="#using-fast-math-functions">Using fast math functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#nvidia-fermi-cards">NVIDIA Fermi cards</a><ul>
<li><a class="reference internal" href="#block-size">Block size</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-comparison-for-different-devices">Performance comparison for different devices</a><ul>
<li><a class="reference internal" href="#single-precision">Single precision</a></li>
<li><a class="reference internal" href="#double-precision">Double precision</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-impact-of-the-block-size-single-precision">Performance impact of the block size (single precision)</a><ul>
<li><a class="reference internal" href="#geforce-gtx-285">GeForce GTX 285</a></li>
<li><a class="reference internal" href="#tesla-c1060">Tesla C1060</a></li>
<li><a class="reference internal" href="#tesla-c2050">Tesla C2050</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performance-impact-of-the-block-size-double-precision">Performance impact of the block size (double precision)</a><ul>
<li><a class="reference internal" href="#id1">GeForce GTX 285</a></li>
<li><a class="reference internal" href="#id2">Tesla C1060</a></li>
<li><a class="reference internal" href="#id3">Tesla C2050</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="models.html"
                        title="previous chapter">Supported models, grids and boundary conditions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="internals.html"
                        title="next chapter">Sailfish internals</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/performance.txt"
           rel="nofollow">Show Source</a></li>
  </ul><h3>External links</h3>
<ul class="this-page-menu">
	<li><a href="http://gitorious.org/sailfish" rel="nofollow">Download</a></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="internals.html" title="Sailfish internals"
             >next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Supported models, grids and boundary conditions"
             >previous</a> |</li>
        <li><a href="index.html">Sailfish 0.2-alpha1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009-2010, Michał Januszewski.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.
    </div>
  </body>
</html>